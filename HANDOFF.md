# PRD — iOS Share Sheet Shortcut → Windows15 Handoff

Author: Thomas Rohde (project)  
Prepared by: ChatGPT  
Date: 2025-12-21  
Status: Draft

## Summary

Enable “one-tap” sharing from iOS apps (e.g., ChatGPT on iPhone) into the Windows15 **Handoff** app by using an **iOS Shortcut that appears in the Share Sheet**. The shortcut opens a Windows15 deep link containing the shared payload; Windows15 receives the payload and adds a new item to the Handoff Queue via `useHandoff().send(...)`.

This avoids native iOS development and works with Windows15 hosted on GitHub Pages. The solution relies on the iOS Shortcuts Share Sheet capability and Windows15’s existing Handoff hook/API surface.

## Background and problem

Windows15 already supports a cross-device “Handoff Queue” with device targeting and optional encryption, synced via Dexie Cloud. The user experience on iPhone, however, is currently missing a “share into Windows15” entry in the iOS share sheet.

A pure PWA cannot reliably register as a system share target on iOS today (the Web Share Target mechanism is primarily available on Android/ChromeOS). Therefore, the simplest iOS-native entry point without building a native app is an iOS Shortcut exposed in the share sheet.

## Goals

1. From iOS (ChatGPT, Safari, Notes, Mail, etc.), user can Share → **“Send to Windows15 Handoff”** → Windows15 opens and the shared content appears in the Handoff Inbox.
2. No backend required (GitHub Pages compatible).
3. Minimal friction: no copy/paste steps.
4. Works with both:
    - Windows15 in Safari, and
    - Windows15 installed to the iOS Home Screen (PWA mode), where possible.

## Non-goals

- Receiving binary files/images into Handoff (phase 1).
- Implementing a native iOS Share Extension.
- Providing end-to-end encryption from the Shortcut (Shortcut cannot securely handle passphrases without tradeoffs; phase 1 focuses on speed and simplicity).
- Guaranteeing perfect behavior for very large text payloads (URL-length constraints apply).

## Users and key scenarios

Primary user: “Windows15 user with iPhone” who uses Handoff as a cross-device handoff queue.

Top scenarios:

1. Share a ChatGPT answer snippet (text) into Handoff.
2. Share a URL (e.g., from Safari or ChatGPT) into Handoff with an optional note.
3. Target category set to `any` by default; optionally “Work” vs “Private” via separate shortcuts.

## Success metrics

- 90%+ of test shares from ChatGPT iOS add an item to Handoff with correct content.
- Median time from Share tap → item visible in Handoff Inbox: < 2 seconds after Windows15 loads.
- < 1% duplicate inserts from refresh/redo (idempotency implemented).
- Adoption: (optional) number of “share-import” events per active device/week.

## Constraints and assumptions

- Windows15 runs as a SPA on GitHub Pages.
- Handoff is implemented and exposed via `useHandoff()` hook with `send({...})`. (Existing README example.)
- iOS Shortcut passes input to the workflow as “Shortcut Input” and can be shown in the share sheet when configured with input types.
- URL query string length is limited by iOS/app/browser; very long text may fail.

## Solution overview

Deliver two things:

A) **Windows15 deep-link receiver** (in-app)  
A small component that:

1. Detects a share-import deep link via query params.
2. Parses and validates params.
3. Calls `useHandoff().send(...)`.
4. Shows a toast/notification and optionally opens the Handoff app window.
5. Clears the URL (replaceState) to prevent duplicates.

B) **iOS Shortcut(s)**

- “Send to Windows15 Handoff” (targetCategory=any).
- Optional: “Send to Windows15 Handoff (Work)” and “Send to Windows15 Handoff (Private)” for one-tap targeting.

Shortcut behavior:

1. Accept Share Sheet input types (URLs + Text, optionally “Any”).
2. Normalize input to either URL or Text.
3. Build a deep link to the Windows15 GitHub Pages site with encoded parameters.
4. Open the deep link.

## Deep link contract (spec)

Base URL:

- `https://thomasrohde.github.io/windows15/`

Required query parameters:

- `handoff=1` — enables receiver logic
- `nonce=<string>` — idempotency key generated by the Shortcut (required)

Payload parameters (at least one must be present):

- `kind=url|text`
- `target=<urlencoded string>` — for `kind=url`
- `text=<urlencoded string>` — optional note for url, or primary content for text

Optional parameters:

- `targetCategory=work|private|any` (default: `any`)
- `open=handoff` (if present, Windows15 should bring the Handoff app to front)
- `source=<urlencoded string>` (e.g., `ChatGPT iOS`)
- `title=<urlencoded string>` (optional title if the source provides it)
- `ts=<epoch_ms>` (optional timestamp; if absent, Windows15 uses `Date.now()`)

Validation rules:

- `handoff` must equal `1`
- `nonce` must be present and length 6–128
- `kind` must be `url` or `text` (if absent, Windows15 may infer: if `target` is present assume url; else text)
- For `kind=url`: `target` must be a valid http/https URL (best-effort validation)
- For `kind=text`: `text` must be non-empty
- Length limits (defensive; tune as needed):
    - `target` <= 4096 chars
    - `text` <= 20000 chars (note: likely far below practical URL limits; this is guardrail only)

Idempotency:

- Windows15 must prevent duplicates on refresh/back/forward.
- Store the last N processed `nonce` values in localStorage (e.g., ring buffer of 50) and ignore repeats.

## UX requirements

1. When a deep link is processed successfully:
    - Show toast: “Sent to Handoff”
    - If `open=handoff` is set, open/focus the Handoff app window.
2. If the deep link is invalid:
    - Do not insert anything.
    - Show a lightweight toast: “Nothing to send” (do not spam).
3. After processing (success or no-op), clear the relevant query params via `history.replaceState()`.

## Functional requirements

FR-1: Parse deep link parameters on app startup

- Must work even if the user lands on the root URL.
- Must run early enough that the user sees feedback quickly.

FR-2: Normalize payload to Handoff item shape  
Map to the existing Handoff hook API:

- `kind`: `url` or `text`
- `target`: URL for `url`, empty string for `text`
- `text`: optional note or the text itself
- `targetCategory`: `work|private|any`

FR-3: Send item  
Call `await send({ kind, target, text, targetCategory })`.

FR-4: Idempotency  
Do not re-send the same `nonce` twice on the same device.

FR-5: Observability (light)  
Optionally log an internal event:

- `handoff_share_import_success`
- `handoff_share_import_ignored_duplicate`
- `handoff_share_import_invalid`

Do not log the actual content.

## Security and privacy

- Content is placed into the URL query parameters, meaning it may appear in browser history and is visible to the OS/app logs in some cases.
- Phase 1 should recommend sharing **non-sensitive** content only (links and non-confidential text).
- Windows15 already supports “Sensitive Mode” with encryption in-app, but Shortcut-driven encryption is out of scope for this phase.
- If the user has Dexie Cloud sync enabled, the content will sync according to Windows15’s existing security model.

## Accessibility

- Toast notifications must be screen-reader friendly.
- If the Handoff app is opened automatically, ensure focus management does not trap the user.

## Compatibility

- iOS: Shortcut appears in share sheet when accepted input types match the host app’s shared payload.
- Windows15: Works on GitHub Pages; no server rewrite rules required.
- If Windows15 uses hash-based routing, the query params remain accessible from `window.location.search`.

## Implementation outline

### Windows15 changes

1. Add a “Share Receiver” component (e.g., `components/ShareReceiver.tsx`) mounted near the top of the app.
2. Implement:
    - parse + validate + decode
    - idempotency store for `nonce`
    - call `useHandoff().send(...)`
    - toast + optional open/focus Handoff
    - URL cleanup

3. Add unit tests for:
    - decoding
    - validation
    - idempotency behavior

4. Add a short doc page: `docs/ios-share-sheet-shortcut.md`

### iOS Shortcut deliverables

1. Create shortcut “Send to Windows15 Handoff”
    - Show in Share Sheet: ON
    - Accepted Types: URLs + Text (or Any)
2. Steps:
    - Read “Shortcut Input”
    - Try extract URL(s); if present, set kind=url and target=first URL
    - Else kind=text and text=Shortcut Input as text
    - Generate `nonce` (e.g., Random Number + timestamp concatenation)
    - URL Encode `target` and `text`
    - Construct deep link:
      `https://thomasrohde.github.io/windows15/?handoff=1&nonce=...&kind=...&target=...&text=...&targetCategory=any&open=handoff&source=ChatGPT%20iOS`
    - Open URL

3. Optional shortcuts:
    - “Send to Windows15 Handoff (Work)” sets `targetCategory=work`
    - “Send to Windows15 Handoff (Private)” sets `targetCategory=private`

Distribution options:

- Provide an iCloud Shortcut share link in the docs (recommended for users).
- Optionally commit an exported `.shortcut` file under `docs/shortcuts/` (if you prefer repo-based distribution).

## Acceptance criteria

AC-1: From ChatGPT iOS, sharing a URL to “Send to Windows15 Handoff” results in a new Handoff Inbox item with:

- kind=url
- target populated with the shared URL
- text either empty or the provided note

AC-2: From ChatGPT iOS, sharing selected text results in a new Handoff Inbox item with:

- kind=text
- text populated with the shared text
- target empty

AC-3: After import, refreshing the page does not create duplicates (nonce-based idempotency).

AC-4: If the user has Dexie Cloud set up on iPhone and desktop, the new item syncs to the other device using existing Handoff sync (no changes required).

## Test plan

Manual tests (iPhone):

- Share URL from Safari → shortcut → verify Handoff receives URL
- Share text from ChatGPT → shortcut → verify Handoff receives text
- Share both (if host app provides both) → ensure correct normalization
- Repeat share (same nonce should not happen; but refresh should not duplicate)
- Airplane mode: ensure behavior is reasonable (local insert should still occur; cloud sync later)

Automated tests:

- Unit tests for param parsing and idempotency store
- Playwright E2E:
    - Load app with deep link URL and assert UI shows new item (or DB contains it)

## Rollout plan

- Merge behind a soft flag if desired:
    - Only process when `handoff=1` is present (so there is no risk to normal navigation).
- Document in README under Handoff section: “iOS Share Sheet Shortcut”.

## Risks and mitigations

Risk: URL too long for large text payloads  
Mitigation: Phase 1 accepts this limitation; document it. Phase 2 can add a small “payload drop” endpoint returning a token.

Risk: Duplicates from repeated open / back / refresh  
Mitigation: `nonce` required + local “seen nonces” ring buffer.

Risk: Users share sensitive data unintentionally  
Mitigation: Add a warning in docs and optionally a confirm dialog when `text` exceeds a size threshold or matches patterns (optional).

## Future enhancements (phase 2+)

- Optional backend “dropbox” endpoint (Cloudflare Worker) to accept large payloads and return short token; Shortcut posts the payload, then opens Windows15 with `token=...`.
- A dedicated “Inbox Import” UI to preview and confirm the import.
- Support for images/files (requires backend or native wrapper; evaluate).
- Optional passphrase-based encryption initiated by Shortcut (likely via prompt + in-app secure UI; careful UX).

## References

- Windows15 README (Handoff feature + `useHandoff().send` usage example).
- Apple Shortcuts documentation: configuring share sheet input types (“Show in Share Sheet”, accepted types).
